#! /usr/bin/env bash
#
# Update values of Zeek script variables on a running Zeek.
#
# update <host> <port> <zeek_args>
#
# host:  the destination host.
# port:  the destination port.
# zeek_args:  Zeek cmd-line arguments.

. `dirname $0`/zeekctl-config.sh

if [ $# -lt 4 ]; then
    echo "update: missing arguments"
    exit 1
fi

if [ ! -f "${zeek}" ]; then
    echo "update: file not found: ${zeek}"
    exit 1
fi

export PATH=${bindir}:${scriptsdir}:$PATH

use_installed_policies=1
. "${scriptsdir}"/set-zeek-path
if [ $? -ne 0 ]; then
    exit 1
fi

host=$1
port=$2
shift 2

# Create temporary working directory.
if [ ! -d "${tmpdir}" ]; then
    echo "update: directory not found: ${tmpdir}"
    exit 1
fi
dir=${tmpdir}/update-$$
rm -rf "$dir"
mkdir "$dir"

cd "$dir"
if [ $? -ne 0 ]; then
    exit 1
fi

ZEEKCTL_DISABLE_LISTEN=1 "${zeek}" "$@" frameworks/control/controller "Control::host=$host" "Control::host_port=$port" "Control::cmd=configuration_update" >out.log 2>&1
rc=$?

grep -v -e "warning: no such host" -e "received termination signal" out.log

rm -rf "$dir"

exit $rc

